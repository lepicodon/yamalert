{% extends 'base.html' %}

{% block content %}
  <div class="container-fluid py-3">
    <div class="row mb-3">
      <div class="col-12 d-flex justify-content-between align-items-center">
        <h3 class="mb-0">Prometheus & Alertmanager Config Builder</h3>
        <div>
          <select id="themeSelect" class="form-select form-select-sm d-inline-block w-auto me-2">
            <option value="default">Theme: Light</option>
            <option value="dark">Theme: Dark</option>
            <option value="corporate">Theme: Corporate</option>
            <option value="nordic">Theme: Nordic</option>
            <option value="monokai">Theme: Monokai</option>
            <option value="cyberpunk">Theme: Cyberpunk</option>
            <option value="nature">Theme: Nature</option>
            <option value="ocean">Theme: Ocean</option>
            <option value="sunset">Theme: Sunset</option>
            <option value="winter">Theme: Winter</option>
            <option value="desert">Theme: Desert</option>
          </select>
          {% if current_user.is_authenticated %}
            <button id="mergeTemplatesBtn" class="btn btn-outline-primary btn-sm me-2">Merge Templates</button>
            <button id="newTemplateBtn" class="btn btn-primary btn-sm me-2">New Template</button>
            <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary btn-sm">Logout</a>
          {% else %}
            <a href="{{ url_for('login') }}" class="btn btn-outline-primary btn-sm">Login</a>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="row g-3">
      <!-- Left: Templates Library -->
      <div class="col-12 col-lg-3">
        <div class="card h-100">
          <div class="card-header">Templates Library</div>
          <div class="card-body">
            <div class="mb-3">
              <input type="text" id="templateSearch" class="form-control form-control-sm" placeholder="Search..." />
            </div>
            <div id="templatesList" class="list-group" style="max-height: 65vh; overflow-y: auto;"></div>
          </div>
        </div>
      </div>

      <!-- Middle: Editor -->
      <div class="col-12 col-lg-5">
        <div class="card h-100">
          <div class="card-header">Editor</div>
          <div class="card-body">
            <form id="editorForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Name</label>
                  <input type="text" class="form-control" id="name" required />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Type</label>
                  <select class="form-select" id="type">
                    <option value="rule">Prometheus Rule</option>
                    <option value="alertmanager">Alertmanager Config</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Job Category</label>
                  <input type="text" class="form-control" id="job_category" placeholder="e.g., Telegraf, VMware, Ping" />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Sensor</label>
                  <input type="text" class="form-control" id="sensor_type" placeholder="e.g., CPU, Memory, Disk, Latency" />
                </div>
                <div class="col-12">
                  <label class="form-label">Description</label>
                  <textarea class="form-control" id="description" rows="2"></textarea>
                </div>
              </div>
              <hr />
              <div id="editorArea">
                <!-- Dynamic editor (YAML) injected here -->
              </div>
            </form>
          </div>
          <div class="card-footer">
            <div id="templateTimestamps" class="mb-2" style="font-size: 0.75rem;"></div>
            <div class="d-flex justify-content-end gap-2">
              <button id="copyBtn" class="btn btn-outline-secondary btn-sm">Copy YAML</button>
              <button id="downloadBtn" class="btn btn-outline-success btn-sm">Download</button>
              {% if current_user.is_authenticated %}
                <button id="saveTemplateBtn" class="btn btn-primary btn-sm">Save Template</button>
                <button id="deleteTemplateBtn" class="btn btn-outline-danger btn-sm">Delete</button>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Right: YAML Preview and Validation -->
      <div class="col-12 col-lg-4">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>YAML Preview</div>
            <small id="validationStatus" class="text-muted">No validation yet</small>
          </div>
          <div class="card-body">
            <textarea id="yamlPreview" class="form-control" rows="18" spellcheck="false"></textarea>
            <div class="mt-2">
              <small id="validationErrors" class="text-danger"></small>
              <div class="mt-1"><small id="promqlSummary" class="text-muted"></small></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Help Section -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#helpSection" aria-expanded="false" aria-controls="helpSection">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Help & Examples</h5>
              <i class="bi bi-chevron-down"></i>
            </div>
          </div>
          <div id="helpSection" class="collapse card-body">
            <div class="row">
              <!-- Left Column -->
              <div class="col-md-6">
                <h6>Quick Start</h6>
                <ul>
                  <li>Create a new template with the One-Click YAML or select an existing one from the library</li>
                  <li>Choose the template type (Prometheus Rule or Alertmanager Config)</li>
                  <li>Fill in metadata (name, category, sensor type, description)</li>
                  <li>Write your YAML or use the Editor for rules</li>
                </ul>

                <h6 class="mt-4">One-Click YAML</h6>
                <p class="text-muted small mb-2">Click to insert example templates:</p>
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-secondary btn-sm" onclick="insertExample('alert')">Alert Rule</button>
                  <button class="btn btn-outline-secondary btn-sm" onclick="insertExample('record')">Recording Rule</button>
                  <button class="btn btn-outline-secondary btn-sm" onclick="insertExample('combined')">Combined Rules</button>
                </div>
              </div>

              <!-- Right Column -->
              <div class="col-md-6">
                <h6>Template Types</h6>
                <dl>
                  <dt>Prometheus Rule</dt>
                  <dd>Contains alert and recording rules. Must have a 'groups' key with a list of rule groups.</dd>
                  <dt>Alertmanager Config</dt>
                  <dd>Contains routing and receiver configurations. Must have 'route' and 'receivers' keys.</dd>
                </dl>

                <h6 class="mt-4">Tips</h6>
                <ul>
                  <li>Use meaningful template names and descriptions to help others understand your rules</li>
                  <li>Group related rules together in the same template</li>
                  <li>Use job categories and sensor types to organize your templates</li>
                  <li>Test your PromQL expressions before saving</li>
                  <li>Use the merge feature to combine rules from multiple templates</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Merge Templates Modal -->
  <div class="modal fade" id="mergeTemplatesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Merge Templates</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <h6>Available Templates</h6>
              <div id="mergeTemplatesList" class="list-group" style="max-height: 400px; overflow-y: auto;">
                <!-- Template list for merging -->
              </div>
            </div>
            <div class="col-md-6">
              <h6>Selected Rules</h6>
              <div id="selectedRulesList" class="border rounded p-3" style="max-height: 400px; overflow-y: auto; min-height: 200px;">
                <p class="text-muted">Select templates and rules to merge...</p>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="mergeSelectedTemplatesBtn" class="btn btn-primary">Merge Selected</button>
          <button id="clearMergeBtn" class="btn btn-outline-secondary">Clear All</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Small inline examples object used by the external JS -->
  <script>
    window.EXAMPLES = {
      alert: `{% raw %}groups:
  - name: example_alerts
    rules:
      - alert: HighCPU
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: High CPU on {{ $labels.instance }}{% endraw %}`,
      record: `{% raw %}groups:
  - name: example_recordings
    rules:
      - record: instance:cpu_usage:rate5m
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100){% endraw %}`,
      combined: `{% raw %}groups:
  - name: example_combined
    rules:
      - alert: HighMemory
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
      - record: instance:memory_usage:percent
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100{% endraw %}`
    };
  </script>

{% endblock %}