<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Prometheus & Alertmanager Config Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="/static/css/theme.css" />
</head>
<body>
  <div class="container-fluid py-3">
    <div class="row mb-3">
      <div class="col-12 d-flex justify-content-between align-items-center">
        <h3 class="mb-0">Prometheus & Alertmanager Config Builder</h3>
        <div>
          <select id="themeSelect" class="form-select form-select-sm d-inline-block w-auto me-2">
            <option value="default">Theme: Default</option>
            <option value="dark">Theme: Dark</option>
            <option value="corporate">Theme: Corporate</option>
            <option value="solarized">Theme: Solarized</option>
            <option value="mono">Theme: Mono</option>
            <option value="midnight">Theme: Midnight</option>
            <option value="pastel">Theme: Pastel</option>
            <option value="matrix">Theme: Matrix</option>
            <option value="sepia">Theme: Sepia</option>
            <option value="neon">Theme: Neon</option>
          </select>
          <button id="mergeTemplatesBtn" class="btn btn-outline-primary btn-sm me-2">Merge Templates</button>
          <button id="newTemplateBtn" class="btn btn-primary btn-sm">New Template</button>
        </div>
      </div>
    </div>

    <div class="row g-3">
      <!-- Left: Templates Library -->
      <div class="col-12 col-lg-3">
        <div class="card h-100">
          <div class="card-header">Templates Library</div>
          <div class="card-body">
            <div class="mb-3">
              <input type="text" id="templateSearch" class="form-control form-control-sm" placeholder="Search..." />
            </div>
            <div id="templatesList" class="list-group" style="max-height: 65vh; overflow-y: auto;"></div>
          </div>
        </div>
      </div>

      <!-- Middle: Editor -->
      <div class="col-12 col-lg-5">
        <div class="card h-100">
          <div class="card-header">Editor</div>
          <div class="card-body">
            <form id="editorForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Name</label>
                  <input type="text" class="form-control" id="name" required />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Type</label>
                  <select class="form-select" id="type">
                    <option value="rule">Prometheus Rule</option>
                    <option value="alertmanager">Alertmanager Config</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Job Category</label>
                  <input type="text" class="form-control" id="job_category" placeholder="e.g., Telegraf, VMware, Ping" />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Sensor</label>
                  <input type="text" class="form-control" id="sensor_type" placeholder="e.g., CPU, Memory, Disk, Latency" />
                </div>
                <div class="col-12">
                  <label class="form-label">Description</label>
                  <textarea class="form-control" id="description" rows="2"></textarea>
                </div>
              </div>
              <hr />
              <div id="editorArea">
                <!-- Dynamic editor (YAML) injected here -->
              </div>
            </form>
          </div>
          <div class="card-footer d-flex justify-content-end">
            <button id="copyBtn" class="btn btn-outline-secondary btn-sm me-2">Copy YAML</button>
            <button id="saveTemplateBtn" class="btn btn-primary btn-sm me-2">Save Template</button>
            <button id="downloadBtn" class="btn btn-success btn-sm">Download</button>
          </div>
        </div>
      </div>

      <!-- Right: YAML Preview and Validation -->
      <div class="col-12 col-lg-4">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>YAML Preview</div>
            <small id="validationStatus" class="text-muted">No validation yet</small>
          </div>
          <div class="card-body">
            <textarea id="yamlPreview" class="form-control" rows="18" spellcheck="false"></textarea>
            <div class="mt-2">
              <small id="validationErrors" class="text-danger"></small>
              <div class="mt-1"><small id="promqlSummary" class="text-muted"></small></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Merge Templates Modal -->
  <div class="modal fade" id="mergeTemplatesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Merge Templates</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <h6>Available Templates</h6>
              <div id="mergeTemplatesList" class="list-group" style="max-height: 400px; overflow-y: auto;">
                <!-- Template list for merging -->
              </div>
            </div>
            <div class="col-md-6">
              <h6>Selected Rules</h6>
              <div id="selectedRulesList" class="border rounded p-3" style="max-height: 400px; overflow-y: auto; min-height: 200px;">
                <p class="text-muted">Select templates and rules to merge...</p>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="mergeSelectedTemplatesBtn" class="btn btn-primary">Merge Selected</button>
          <button id="clearMergeBtn" class="btn btn-outline-secondary">Clear All</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ────────────────────────────────────────────────────────────────
    // Global state
    // ────────────────────────────────────────────────────────────────
    const state = {
      templates: [],
      filteredTemplates: [],
      current: null,          // {id, name, type, job_category, sensor_type, description, content}
      promqlCache: {},         // expr → boolean
      editorMode: 'yaml',      // 'yaml' or 'form'
    mergeSelected: [],       // Rules selected for merging
    selectedTemplateIds: []  // Currently selected templates for merging (supports multi-select)
    };

    // ────────────────────────────────────────────────────────────────
    // Helper utilities
    // ────────────────────────────────────────────────────────────────
    function escapeHtml(text) {
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
      return (text || '').replace(/[&<>"']/g, m => map[m]);
    }

    function debounce(fn, wait) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), wait);
      }
    }

    // ────────────────────────────────────────────────────────────────
    // Theme handling
    // ────────────────────────────────────────────────────────────────
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
    }

    function applySavedTheme() {
      const theme = localStorage.getItem('theme') || 'default';
      document.querySelector('#themeSelect').value = theme;
      setTheme(theme);
    }

    // ────────────────────────────────────────────────────────────────
    // Render editor (YAML) based on type
    // ────────────────────────────────────────────────────────────────
    function renderEditor(st) {
      const editorArea = document.getElementById('editorArea');
      if (st.type === 'rule') {
        editorArea.innerHTML = `
          <div class="mb-3">
            <div class="btn-group" role="group" aria-label="Editor mode">
              <input type="radio" class="btn-check" name="editorMode" id="modeYaml" value="yaml" ${state.editorMode === 'yaml' ? 'checked' : ''}>
              <label class="btn btn-outline-primary btn-sm" for="modeYaml">YAML</label>
              
              <input type="radio" class="btn-check" name="editorMode" id="modeForm" value="form" ${state.editorMode === 'form' ? 'checked' : ''}>
              <label class="btn btn-outline-primary btn-sm" for="modeForm">Form Editor</label>
            </div>
          </div>
          
          <div id="yamlEditorSection" style="display: ${state.editorMode === 'yaml' ? 'block' : 'none'}">
            <label class="form-label">YAML</label>
            <textarea id="yamlEditor" class="form-control" rows="16" spellcheck="false">${escapeHtml(st.content)}</textarea>
          </div>
          
          <div id="formEditorSection" style="display: ${state.editorMode === 'form' ? 'block' : 'none'}">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="mb-0">Rule Builder</h6>
              <div>
                <button id="addRuleBtn" class="btn btn-sm btn-primary me-2">Add Rule</button>
                <button id="addGroupBtn" class="btn btn-sm btn-outline-secondary">Add Group</button>
              </div>
            </div>
            <div id="ruleBuilderArea">
              <!-- Rule builder UI injected here -->
            </div>
          </div>
        `;
        
        // Bind editor mode switching
        setTimeout(() => {
          document.querySelectorAll('input[name="editorMode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
              state.editorMode = e.target.value;
              renderEditor(st);
            });
          });
          
          // Bind form editor buttons
          const addRuleBtn = document.getElementById('addRuleBtn');
          const addGroupBtn = document.getElementById('addGroupBtn');
          
          if (addRuleBtn) {
            addRuleBtn.onclick = (e) => {
              e.preventDefault();
              addNewRule();
            };
          }
          
          if (addGroupBtn) {
            addGroupBtn.onclick = (e) => {
              e.preventDefault();
              addNewGroup();
            };
          }
          
          // Render the form editor
          renderFormEditor(st.content);
        }, 100);
        
      } else {
        editorArea.innerHTML = `
          <label class="form-label">YAML</label>
          <textarea id="yamlEditor" class="form-control" rows="16" spellcheck="false">${escapeHtml(st.content)}</textarea>
        `;
      }
    }

    // ────────────────────────────────────────────────────────────────
    // Template Merging Functions
    // ────────────────────────────────────────────────────────────────
    function openMergeTemplatesModal() {
      const modal = new bootstrap.Modal(document.getElementById('mergeTemplatesModal'));
      modal.show();
      
      // Populate templates list
      const list = document.getElementById('mergeTemplatesList');
      list.innerHTML = '';
      // Render templates as selectable checkboxes so multiple templates may be chosen
      state.templates.filter(t => t.type === 'rule').forEach(t => {
        const wrapper = document.createElement('div');
        wrapper.className = 'list-group-item';
        wrapper.innerHTML = `
          <div class="form-check">
            <input class="form-check-input template-select" type="checkbox" value="${t.id}" id="merge-tmpl-${t.id}" data-template-id="${t.id}">
            <label class="form-check-label" for="merge-tmpl-${t.id}">
              <strong>${t.name}</strong><br>
              <small class="text-muted">${t.job_category || 'General'}  ${t.sensor_type || 'N/A'}</small>
            </label>
          </div>
        `;
        list.appendChild(wrapper);
      });

      // When template checkboxes change, optionally update rules preview (kept for now)
      list.querySelectorAll('.template-select').forEach(cb => {
        cb.addEventListener('change', () => updateMergeRulesPanel());
      });

      // Bind modal buttons: single merge action that fetches selected templates' full content
      document.getElementById('mergeSelectedTemplatesBtn').onclick = mergeSelectedTemplates;
      document.getElementById('clearMergeBtn').onclick = clearMergeSelection;
    }

    // Build and show rules from all selected templates
    function updateMergeRulesPanel() {
      const checked = Array.from(document.querySelectorAll('#mergeTemplatesList .template-select:checked')).map(cb => Number(cb.value));
      state.selectedTemplateIds = checked;

      const rulesPanel = document.getElementById('selectedRulesList');
      if (!checked.length) {
        rulesPanel.innerHTML = '<p class="text-muted">Select templates and rules to merge...</p>';
        return;
      }

      let combinedHTML = '';
      checked.forEach(tid => {
        const template = state.templates.find(t => t.id === tid);
        if (!template) return;
        let groups = [];
        try {
          const doc = jsyaml.load(template.content);
          groups = (doc && doc.groups) ? doc.groups : [];
        } catch (err) {
          combinedHTML += `<div class="mb-2 text-danger">Error parsing template ${template.name}</div>`;
          return;
        }

        combinedHTML += `<h6 class="mb-2">Rules from: ${template.name}</h6>`;
        groups.forEach((group, gi) => {
          combinedHTML += `<div class="border rounded p-2 mb-2"><h6>Group: ${group.name || 'unnamed'}</h6>`;
          (group.rules || []).forEach((rule, ri) => {
            const ruleName = rule.alert || rule.record || `Rule ${ri + 1}`;
            // Include template id in checkbox data so selections across templates are unique
            combinedHTML += `
              <div class="form-check">
                <input class="form-check-input merge-rule-select" type="checkbox" 
                       data-template-id="${template.id}" data-gi="${gi}" data-ri="${ri}" id="rule-${template.id}-${gi}-${ri}">
                <label class="form-check-label" for="rule-${template.id}-${gi}-${ri}">
                  <strong>${ruleName}</strong> <small class="text-muted">from ${template.name}</small>
                </label>
              </div>
            `;
          });
          combinedHTML += `</div>`;
        });
      });

      rulesPanel.innerHTML = combinedHTML || '<p class="text-muted">No rules found in the selected templates.</p>';
    }

    function addSelectedToMerge() {
      const added = collectCheckedRulesIntoMergeSelected();
      if (added === 0) {
        alert('No rules selected for merging');
        return;
      }

      // Update the selected rules display
      updateMergeSelectionDisplay();
      
      // Clear selections
      document.querySelectorAll('#selectedRulesList input[type="checkbox"]').forEach(cb => cb.checked = false);
    }

    // Helper: collect checked rules from the rules panel and push them into state.mergeSelected
    function collectCheckedRulesIntoMergeSelected() {
      const checkedRules = Array.from(document.querySelectorAll('#selectedRulesList input.merge-rule-select:checked'));
      if (!checkedRules.length) return 0;

      let count = 0;
      checkedRules.forEach(cb => {
        const tid = Number(cb.getAttribute('data-template-id'));
        const gi = Number(cb.getAttribute('data-gi'));
        const ri = Number(cb.getAttribute('data-ri'));
        const template = state.templates.find(t => t.id === tid);
        if (!template) return;
        let groups = [];
        try {
          const doc = jsyaml.load(template.content);
          groups = (doc && doc.groups) ? doc.groups : [];
        } catch (err) {
          return;
        }
        const group = groups[gi];
        const rule = group?.rules?.[ri];
        if (rule) {
          state.mergeSelected.push({
            templateName: template.name,
            groupName: group.name || `group_${gi + 1}`,
            rule: {...rule}
          });
          count += 1;
        }
      });
      return count;
    }

    // Merge selected templates directly: fetch each template by id and merge its rules
    async function mergeSelectedTemplates() {
      // Collect selected template ids from the left list
      const tmplIds = Array.from(document.querySelectorAll('#mergeTemplatesList .template-select:checked')).map(cb => Number(cb.value));
      if (!tmplIds.length) {
        alert('Please select at least one template to merge');
        return;
      }

      const groupedRules = {};

      for (const tid of tmplIds) {
        try {
          // Fetch template content from server
          const resp = await fetch(`/api/template/${tid}`);
          if (!resp.ok) {
            console.warn('Failed to fetch template', tid);
            continue;
          }
          const t = await resp.json();
          let doc;
          try { doc = jsyaml.load(t.content); } catch (e) { console.warn('invalid yaml for', t.name); continue; }

          const groups = (doc && doc.groups) ? doc.groups : [];
          groups.forEach(g => {
            // Namespace group names by template name to avoid collisions
            const groupName = `${t.name} / ${g.name || 'unnamed'}`;
            groupedRules[groupName] = groupedRules[groupName] || [];
            (g.rules || []).forEach(r => groupedRules[groupName].push(r));
          });
        } catch (err) {
          console.warn('Error merging template', tid, err);
        }
      }

      // Convert groupedRules to YAML
      const mergedGroups = Object.keys(groupedRules).map(name => ({ name, rules: groupedRules[name] }));
      const mergedYaml = jsyaml.dump({groups: mergedGroups}, {sortKeys: false});

      // Update current state and editor
      state.current = state.current || { id: null, name: 'Merged Rules', type: 'rule', job_category: '', sensor_type: '', description: '', content: '' };
      state.current.content = mergedYaml;
      state.current.name = 'Merged Rules';
      state.editorMode = 'yaml';

      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('mergeTemplatesModal'));
      if (modal) modal.hide();

      // Clear merge selection UI
      document.querySelectorAll('#mergeTemplatesList .template-select').forEach(cb => cb.checked = false);
      document.getElementById('selectedRulesList').innerHTML = '<p class="text-muted">Select templates and rules to merge...</p>';

      // Apply to editor
      applyStateToForm();
    }

    function updateMergeSelectionDisplay() {
      const panel = document.getElementById('selectedRulesList');
      
      if (state.mergeSelected.length === 0) {
        panel.innerHTML = '<p class="text-muted">Select templates and rules to merge...</p>';
        return;
      }
      
      let html = '<h6>Selected Rules for Merge:</h6>';
      state.mergeSelected.forEach((item, index) => {
        const ruleName = item.rule.alert || item.rule.record || `Rule ${index + 1}`;
        html += `
          <div class="border rounded p-2 mb-2">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>${ruleName}</strong> <small class="text-muted">from ${item.templateName}</small><br>
                <small>Group: ${item.groupName}</small>
              </div>
              <button class="btn btn-sm btn-outline-danger" onclick="removeFromMerge(${index})">Remove</button>
            </div>
          </div>
        `;
      });
      
      panel.innerHTML = html;
    }

    function removeFromMerge(index) {
      state.mergeSelected.splice(index, 1);
      updateMergeSelectionDisplay();
    }

    function clearMergeSelection() {
      state.mergeSelected = [];
      updateMergeSelectionDisplay();
    }

    function applyTemplateMerge() {
      // If user didn't explicitly add selected rules, collect checked rules now.
      if (state.mergeSelected.length === 0) {
        collectCheckedRulesIntoMergeSelected();
      }

      if (state.mergeSelected.length === 0) {
        alert('No rules selected for merging');
        return;
      }
      
      // Group selected rules by group name
      const groupedRules = {};
      state.mergeSelected.forEach(item => {
        if (!groupedRules[item.groupName]) {
          groupedRules[item.groupName] = [];
        }
        groupedRules[item.groupName].push(item.rule);
      });
      
      // Create merged groups
      const mergedGroups = Object.keys(groupedRules).map(groupName => ({
        name: groupName,
        rules: groupedRules[groupName]
      }));
      
      // Generate YAML
      const mergedYaml = jsyaml.dump({groups: mergedGroups}, {sortKeys: false});
      
      // Update current state
      state.current.content = mergedYaml;
      state.current.name = 'Merged Rules';
      state.editorMode = 'yaml';
      
      // Close modal and apply
      const modal = bootstrap.Modal.getInstance(document.getElementById('mergeTemplatesModal'));
      modal.hide();
      
      // Clear merge selection
      clearMergeSelection();
      
      // Apply to editor
      applyStateToForm();
    }

    // ────────────────────────────────────────────────────────────────
    // Form Editor Functions
    // ────────────────────────────────────────────────────────────────
    function parseYamlToGroups(yamlContent) {
      try {
        const doc = jsyaml.load(yamlContent);
        return (doc && doc.groups) ? doc.groups : [];
      } catch (err) {
        return [];
      }
    }

    function groupsToYaml(groups) {
      return jsyaml.dump({groups: groups}, {sortKeys:false});
    }

    function renderFormEditor(yamlContent) {
      const builderArea = document.getElementById('ruleBuilderArea');
      const groups = parseYamlToGroups(yamlContent);
      
      if (groups.length === 0) {
        builderArea.innerHTML = `
          <div class="text-center text-muted py-5">
            <p>No rules yet. Click "Add Rule" to start building your Prometheus rules.</p>
            <button class="btn btn-primary btn-sm" onclick="addNewRule()">Add First Rule</button>
          </div>
        `;
        return;
      }
      
      let html = '';
      groups.forEach((group, gi) => {
        html += `
          <div class="border rounded p-3 mb-3" data-group="${gi}">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Group: <input type="text" class="form-control form-control-sm d-inline-block" style="width: 200px;" 
                      value="${group.name || ''}" data-field="groupName" data-group="${gi}" placeholder="group name"></h6>
              <button class="btn btn-sm btn-outline-danger" onclick="removeGroup(${gi})">Remove Group</button>
            </div>
            <div class="rules-container">
        `;
        
        (group.rules || []).forEach((rule, ri) => {
          html += renderRuleForm(rule, gi, ri);
        });
        
        html += `
            </div>
            <button class="btn btn-sm btn-outline-primary mt-2" onclick="addRuleToGroup(${gi})">Add Rule to Group</button>
          </div>
        `;
      });
      
      builderArea.innerHTML = html;
      
      // Bind form events
      bindFormEvents();
    }

    function renderRuleForm(rule, groupIndex, ruleIndex) {
      const isAlert = rule.alert ? 'alert' : 'record';
      const labelsStr = Object.entries(rule.labels || {}).map(([k, v]) => `${k}: ${v}`).join('\n');
      const annotationsStr = Object.entries(rule.annotations || {}).map(([k, v]) => `${k}: ${v}`).join('\n');
      
      return `
        <div class="border rounded p-2 mb-2 rule-form" data-group="${groupIndex}" data-rule="${ruleIndex}">
          <div class="row g-2 align-items-end">
            <div class="col-md-2">
              <label class="form-label">Type</label>
              <select class="form-select form-select-sm" data-field="type" data-group="${groupIndex}" data-rule="${ruleIndex}">
                <option value="alert" ${isAlert === 'alert' ? 'selected' : ''}>Alert</option>
                <option value="record" ${isAlert === 'record' ? 'selected' : ''}>Recording</option>
              </select>
            </div>
            <div class="col-md-4 ${isAlert === 'alert' ? '' : 'd-none'}" data-alert-field="true">
              <label class="form-label">Alert Name</label>
              <input type="text" class="form-control form-control-sm" data-field="alert" data-group="${groupIndex}" data-rule="${ruleIndex}" 
                     value="${rule.alert || ''}" placeholder="AlertName">
            </div>
            <div class="col-md-4 ${isAlert === 'record' ? '' : 'd-none'}" data-record-field="true">
              <label class="form-label">Record Name</label>
              <input type="text" class="form-control form-control-sm" data-field="record" data-group="${groupIndex}" data-rule="${ruleIndex}" 
                     value="${rule.record || ''}" placeholder="record:metric_name">
            </div>
            <div class="col-md-2 ${isAlert === 'alert' ? '' : 'd-none'}" data-alert-field="true">
              <label class="form-label">For</label>
              <input type="text" class="form-control form-control-sm" data-field="for" data-group="${groupIndex}" data-rule="${ruleIndex}" 
                     value="${rule.for || ''}" placeholder="5m">
            </div>
            <div class="col-md-1">
              <label class="form-label">&nbsp;</label>
              <button class="btn btn-sm btn-outline-danger d-block w-100" onclick="removeRule(${groupIndex}, ${ruleIndex})">Remove</button>
            </div>
          </div>
          
          <div class="mt-2">
            <label class="form-label">PromQL Expression
              <span class="ms-1 text-muted" data-bs-toggle="tooltip" title="Enter a PromQL expression, e.g. rate(http_requests_total[5m])">?</span>
            </label>
            <textarea class="form-control form-control-sm" rows="2" data-field="expr" data-group="${groupIndex}" data-rule="${ruleIndex}" 
                      placeholder="up == 0">${rule.expr || ''}</textarea>
            <div class="form-text small mt-1 promql-status" data-g="${groupIndex}" data-r="${ruleIndex}"></div>
          </div>
          
          <div class="row g-2 mt-2">
            <div class="col-md-6">
              <label class="form-label">Labels (key: value per line)</label>
              <textarea class="form-control form-control-sm" rows="3" data-field="labels" data-group="${groupIndex}" data-rule="${ruleIndex}" 
                        placeholder="severity: warning">${labelsStr}</textarea>
            </div>
            <div class="col-md-6 ${isAlert === 'alert' ? '' : 'd-none'}" data-alert-field="true">
              <label class="form-label">Annotations (key: value per line)</label>
              <textarea class="form-control form-control-sm" rows="3" data-field="annotations" data-group="${groupIndex}" data-rule="${ruleIndex}" 
                        placeholder="summary: Service is down">${annotationsStr}</textarea>
            </div>
          </div>
        </div>
      `;
    }

    function bindFormEvents() {
      // Type change handling
      document.querySelectorAll('select[data-field="type"]').forEach(select => {
        select.onchange = (e) => {
          const groupIndex = parseInt(e.target.getAttribute('data-group'));
          const ruleIndex = parseInt(e.target.getAttribute('data-rule'));
          toggleRuleFields(groupIndex, ruleIndex, e.target.value);
        };
      });
      
      // Form input handling with PromQL validation
      document.querySelectorAll('input[data-field], textarea[data-field]').forEach(input => {
        input.oninput = debounce((e) => {
          // Validate PromQL expressions
          if (e.target.getAttribute('data-field') === 'expr') {
            const val = e.target.value;
            validatePromQLDebounced(val);
            // update inline status element for this rule
            const g = e.target.getAttribute('data-group');
            const r = e.target.getAttribute('data-rule');
            const statusEl = document.querySelector(`.promql-status[data-g="${g}"][data-r="${r}"]`);
            if (statusEl) {
              statusEl.textContent = 'Checking...';
              // call server
              fetch('/api/validate/promql', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({expr: val})})
                .then(rsp => rsp.json()).then(js => {
                  if (js.valid) {
                    statusEl.textContent = 'Valid PromQL';
                    statusEl.className = 'form-text small mt-1 promql-status text-success';
                  } else {
                    statusEl.textContent = 'Invalid PromQL';
                    statusEl.className = 'form-text small mt-1 promql-status text-danger';
                  }
                }).catch(() => {
                  statusEl.textContent = 'Validation unavailable';
                  statusEl.className = 'form-text small mt-1 promql-status text-muted';
                });
            }
          }
          updateYamlFromForm();
        }, 500);
      });
      
      // Group name changes
      document.querySelectorAll('input[data-field="groupName"]').forEach(input => {
        input.oninput = debounce(() => {
          updateYamlFromForm();
        }, 500);
      });
    }

    function toggleRuleFields(groupIndex, ruleIndex, type) {
      const ruleForm = document.querySelector(`.rule-form[data-group="${groupIndex}"][data-rule="${ruleIndex}"]`);
      if (!ruleForm) return;
      
      // Show/hide fields based on type
      ruleForm.querySelectorAll('[data-alert-field]').forEach(el => {
        el.classList.toggle('d-none', type !== 'alert');
      });
      ruleForm.querySelectorAll('[data-record-field]').forEach(el => {
        el.classList.toggle('d-none', type !== 'record');
      });
      
      updateYamlFromForm();
    }

    function addNewRule() {
      const currentYaml = document.getElementById('yamlEditor').value;
      const groups = parseYamlToGroups(currentYaml);
      
      if (groups.length === 0) {
        // Create first group
        groups.push({
          name: 'default',
          rules: [{
            type: 'alert',
            alert: 'NewAlert',
            expr: 'up == 0',
            for: '5m',
            labels: {severity: 'warning'},
            annotations: {summary: 'New alert'}
          }]
        });
      } else {
        // Add to first group
        groups[0].rules = groups[0].rules || [];
        groups[0].rules.push({
          type: 'alert',
          alert: 'NewAlert',
          expr: 'up == 0',
          for: '5m',
          labels: {severity: 'warning'},
          annotations: {summary: 'New alert'}
        });
      }
      
      const newYaml = groupsToYaml(groups);
      document.getElementById('yamlEditor').value = newYaml;
      onEditorContentChanged();
      renderFormEditor(newYaml);
    }

    function addNewGroup() {
      const currentYaml = document.getElementById('yamlEditor').value;
      const groups = parseYamlToGroups(currentYaml);
      
      groups.push({
        name: `group_${groups.length + 1}`,
        rules: []
      });
      
      const newYaml = groupsToYaml(groups);
      document.getElementById('yamlEditor').value = newYaml;
      onEditorContentChanged();
      renderFormEditor(newYaml);
    }

    function addRuleToGroup(groupIndex) {
      const currentYaml = document.getElementById('yamlEditor').value;
      const groups = parseYamlToGroups(currentYaml);
      
      groups[groupIndex].rules = groups[groupIndex].rules || [];
      groups[groupIndex].rules.push({
        type: 'alert',
        alert: 'NewAlert',
        expr: 'up == 0',
        for: '5m',
        labels: {severity: 'warning'},
        annotations: {summary: 'New alert'}
      });
      
      const newYaml = groupsToYaml(groups);
      document.getElementById('yamlEditor').value = newYaml;
      onEditorContentChanged();
      renderFormEditor(newYaml);
    }

    function removeGroup(groupIndex) {
      const currentYaml = document.getElementById('yamlEditor').value;
      const groups = parseYamlToGroups(currentYaml);
      
      groups.splice(groupIndex, 1);
      
      const newYaml = groupsToYaml(groups);
      document.getElementById('yamlEditor').value = newYaml;
      onEditorContentChanged();
      renderFormEditor(newYaml);
    }

    function removeRule(groupIndex, ruleIndex) {
      const currentYaml = document.getElementById('yamlEditor').value;
      const groups = parseYamlToGroups(currentYaml);
      
      groups[groupIndex].rules.splice(ruleIndex, 1);
      
      const newYaml = groupsToYaml(groups);
      document.getElementById('yamlEditor').value = newYaml;
      onEditorContentChanged();
      renderFormEditor(newYaml);
    }

    function updateYamlFromForm() {
      const groups = [];
      
      // Collect group data
      document.querySelectorAll('[data-group]').forEach(groupEl => {
        const groupIndex = parseInt(groupEl.getAttribute('data-group'));
        const groupName = groupEl.querySelector('input[data-field="groupName"]').value || `group_${groupIndex + 1}`;
        
        const rules = [];
        groupEl.querySelectorAll('.rule-form').forEach(ruleEl => {
          const ruleIndex = parseInt(ruleEl.getAttribute('data-rule'));
          const type = ruleEl.querySelector('select[data-field="type"]').value;
          const expr = ruleEl.querySelector('textarea[data-field="expr"]').value;
          const labels = parseKeyValLines(ruleEl.querySelector('textarea[data-field="labels"]').value);
          const annotations = parseKeyValLines(ruleEl.querySelector('textarea[data-field="annotations"]')?.value || '');
          
          const rule = { expr, labels };
          
          if (type === 'alert') {
            rule.alert = ruleEl.querySelector('input[data-field="alert"]').value;
            rule.for = ruleEl.querySelector('input[data-field="for"]').value;
            rule.annotations = annotations;
          } else {
            rule.record = ruleEl.querySelector('input[data-field="record"]').value;
          }
          
          rules.push(rule);
        });
        
        groups.push({ name: groupName, rules });
      });
      
      const newYaml = groupsToYaml(groups);
      document.getElementById('yamlEditor').value = newYaml;
      onEditorContentChanged();
    }

    function parseKeyValLines(text) {
      const obj = {};
      (text || '').split('\n').forEach(line => {
        const t = line.trim();
        if (!t) return;
        const m = t.match(/^([^:]+):\s*(.*)$/);
        if (m) obj[m[1].trim()] = m[2].trim();
      });
      return obj;
    }

    // ────────────────────────────────────────────────────────────────
    // Apply current state to the form
    // ────────────────────────────────────────────────────────────────
    function applyStateToForm() {
      const st = state.current;
      if (!st) return;
      document.getElementById('name').value = st.name || '';
      document.getElementById('type').value = st.type || 'rule';
      document.getElementById('job_category').value = st.job_category || '';
      document.getElementById('sensor_type').value = st.sensor_type || '';
      document.getElementById('description').value = st.description || '';

      renderEditor(st);
      onEditorContentChanged();
    }

    // Save current template to the library (POST /api/template)
    async function saveTemplate() {
    // Ensure editor changes are applied to preview (sync editor → preview)
    try {
      onEditorContentChanged();
    } catch (e) {
      // ignore if function missing
    }

    // Prefer the YAML editor's value (if present) because users may be editing there
    const yamlEditorEl = document.getElementById('yamlEditor');
    const contentValue = (yamlEditorEl && yamlEditorEl.value && yamlEditorEl.value.trim().length > 0)
      ? yamlEditorEl.value
      : document.getElementById('yamlPreview').value;

    const payload = {
      id: state.current?.id ?? null,
      name: document.getElementById('name').value,
      type: document.getElementById('type').value,
      job_category: document.getElementById('job_category').value,
      sensor_type: document.getElementById('sensor_type').value,
      description: document.getElementById('description').value,
      content: contentValue
    };

      // Basic client-side validation
      if (!payload.name || !payload.name.trim()) {
        alert('Template name is required');
        return;
      }

      try {
        const resp = await fetch('/api/template', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        if (!resp.ok) {
          const js = await resp.json().catch(() => ({}));
          alert('Failed to save template: ' + (js.error || resp.statusText));
          return;
        }
      const js = await resp.json();
      console.log('Save response:', js);
      // If server returned id, set it on current and reload templates
      if (js.id) {
        state.current.id = js.id;
      }
      // Refresh templates list
      await loadTemplates();
      const bytes = js.content_length || 0;
      alert(`Template saved (id=${js.id || 'unknown'}, content ${bytes} bytes)`);
      } catch (err) {
        console.error('saveTemplate error', err);
        alert('Unexpected error saving template');
      }
    }

    // ────────────────────────────────────────────────────────────────
    // PromQL validation (FIXED - More permissive validation)
    // ────────────────────────────────────────────────────────────────
    function validatePromQLDebounced(expr) {
      const key = expr.trim();
      if (!key) return;
      
      if (state.promqlCache.hasOwnProperty(key)) {
        return; // Use cached result
      }
      
      // More permissive validation - just check for basic structure
      const isValid = validatePromQLBasic(expr);
      state.promqlCache[key] = isValid;
      // Call server to validate more thoroughly if basic check passed
      if (isValid) {
        fetch('/api/validate/promql', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({expr})})
          .then(r => r.json()).then(res => {
            // nothing here — inline status handled where this function is used
          }).catch(() => {});
      }
    }

    function validatePromQLBasic(expr) {
      // Basic checks for valid PromQL structure
      if (!expr || expr.length === 0) return false;
      
      // Must contain at least some basic PromQL components
      const hasBasicComponents = /[a-zA-Z_][a-zA-Z0-9_]*(\{.*\})?(\[[0-9smhdMy]+\])?/.test(expr);
      if (!hasBasicComponents) return false;
      
      // Check for balanced braces and brackets
      let braceCount = 0;
      let bracketCount = 0;
      let inString = false;
      let escapeNext = false;
      
      for (let i = 0; i < expr.length; i++) {
        const char = expr[i];
        
        if (escapeNext) {
          escapeNext = false;
          continue;
        }
        
        if (char === '\\') {
          escapeNext = true;
          continue;
        }
        
        if (char === '"' || char === "'") {
          inString = !inString;
          continue;
        }
        
        if (inString) continue;
        
        if (char === '{') braceCount++;
        if (char === '}') braceCount--;
        if (char === '[') bracketCount++;
        if (char === ']') bracketCount--;
        
        if (braceCount < 0 || bracketCount < 0) return false;
      }
      
      return braceCount === 0 && bracketCount === 0;
    }

    // ────────────────────────────────────────────────────────────────
    // Template library UI
    // ────────────────────────────────────────────────────────────────
    function renderTemplatesList() {
      const list = document.getElementById('templatesList');
      list.innerHTML = '';
      state.filteredTemplates.forEach(t => {
        const subtitle = `${t.type === 'rule' ? 'Rule' : 'Alertmanager'} · ${t.job_category || 'General'} · ${t.sensor_type || 'N/A'}`;
        const el = document.createElement('a');
        el.href = '#';
        el.className = 'list-group-item list-group-item-action';
        el.innerHTML = `
          <div class="d-flex w-100 justify-content-between">
            <h6 class="mb-1">${t.name}</h6>
            <div>
              ${t.has_alerts ? `<span class="badge bg-danger rounded-pill py-0 px-1 me-1" data-bs-toggle="tooltip" title="Alerts: ${t.alert_count || 0}" role="img" aria-label="Alerts: ${t.alert_count || 0}">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M1 21h22L12 2 1 21z" fill="#fff"/>
                    <path d="M13 16h-2v2h2v-2zm0-6h-2v4h2V10z" fill="#b30000"/>
                  </svg>
                </span>` : ''}
              ${t.has_recordings ? `<span class="badge bg-secondary rounded-pill py-0 px-1 me-1" data-bs-toggle="tooltip" title="Recordings: ${t.record_count || 0}" role="img" aria-label="Recordings: ${t.record_count || 0}">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <rect x="3" y="10" width="4" height="11" fill="#fff"/>
                    <rect x="9" y="6" width="4" height="15" fill="#fff"/>
                    <rect x="15" y="3" width="4" height="18" fill="#fff"/>
                  </svg>
                </span>` : ''}
              ${t.type === 'alertmanager' ? '<small>Alertmanager</small>' : ''}
            </div>
          </div>
          <small class="text-muted">${subtitle}</small>
        `;
        el.addEventListener('click', (e) => {
          e.preventDefault();
          loadTemplate(t.id);
        });
        list.appendChild(el);
      });
      if (!state.filteredTemplates.length) {
        const el = document.createElement('div');
        el.className = 'text-muted';
        el.textContent = 'No templates found.';
        list.appendChild(el);
      }
      // Initialize any tooltips added to the templates list (badges)
      var tpl = [].slice.call(list.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tpl.map(function (el) { return new bootstrap.Tooltip(el); });
    }

    function loadTemplates() {
      fetch('/api/templates').then(r => r.json()).then(data => {
        state.templates = data;
        state.filteredTemplates = data.slice();
        renderTemplatesList();
      });
    }

    function filterTemplates(query) {
      const q = (query || '').toLowerCase();
      state.filteredTemplates = state.templates.filter(t => {
        return [t.name, t.type, t.job_category, t.sensor_type, t.description]
          .filter(Boolean)
          .some(s => s.toLowerCase().includes(q));
      });
      renderTemplatesList();
    }

    function loadTemplate(id) {
      fetch(`/api/template/${id}`).then(r => r.json()).then(t => {
        state.current = t;
        state.editorMode = 'yaml'; // Always start in YAML mode when loading template
        applyStateToForm();
      });
    }

    // ────────────────────────────────────────────────────────────────
    // Preview & validation
    // ────────────────────────────────────────────────────────────────
    const validatePreview = debounce(() => {
      const content = document.getElementById('yamlPreview').value;
      const ttype = document.getElementById('type').value;
      fetch('/api/validate/yaml', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({content, type: ttype})
      }).then(r => r.json()).then(res => {
        const el = document.getElementById('validationStatus');
        const errEl = document.getElementById('validationErrors');
        const promqlSummary = document.getElementById('promqlSummary');
        if (res.valid) {
          el.textContent = 'Valid';
          el.className = 'text-success';
          errEl.textContent = '';
        } else {
          el.textContent = 'Invalid';
          el.className = 'text-danger';
          errEl.textContent = (res.errors || []).join('\n');
        }
        if (promqlSummary) {
          promqlSummary.textContent = `PromQL checks: ${res.promql_checked || 0} checked, ${res.promql_invalid || 0} invalid`;
        }
      }).catch(() => {
        document.getElementById('validationStatus').textContent = 'Validation unavailable';
        document.getElementById('validationStatus').className = 'text-muted';
      });
    }, 400);

    function onEditorContentChanged() {
      const yamlEl = document.getElementById('yamlEditor');
      const content = yamlEl ? yamlEl.value : document.getElementById('yamlPreview').value;
      document.getElementById('yamlPreview').value = content;

      // Update form editor if in form mode
      if (state.editorMode === 'form') {
        renderFormEditor(content);
      }

      const payload = {
        id: state.current?.id ?? null,
        name: document.getElementById('name').value,
        type: document.getElementById('type').value,
        job_category: document.getElementById('job_category').value,
        sensor_type: document.getElementById('sensor_type').value,
        description: document.getElementById('description').value,
        content
      };
      fetch('/api/state', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      validatePreview();
    }

    // ────────────────────────────────────────────────────────────────
    // UI event bindings
    // ────────────────────────────────────────────────────────────────
    function bindUI() {
      document.getElementById('templateSearch').addEventListener('input', (e) => filterTemplates(e.target.value));
      document.getElementById('mergeTemplatesBtn').addEventListener('click', openMergeTemplatesModal);
      document.getElementById('newTemplateBtn').addEventListener('click', () => {
        state.current = { 
          id: null, 
          name: 'Untitled', 
          type: 'rule', 
          job_category:'', 
          sensor_type:'', 
          description:'', 
          content: 'groups: []' 
        };
        state.editorMode = 'yaml';
        applyStateToForm();
      });
      document.getElementById('type').addEventListener('change', () => {
        const newType = document.getElementById('type').value;
        const defaultContent = (newType === 'rule') ? 'groups: []' : 'route:\n  receiver: default\nreceivers: []\n';
        state.current = {
          id: state.current?.id ?? null,
          name: state.current?.name ?? 'Untitled',
          type: newType,
          job_category: state.current?.job_category ?? '',
          sensor_type: state.current?.sensor_type ?? '',
          description: state.current?.description ?? '',
          content: defaultContent
        };
        state.editorMode = 'yaml'; // Reset to YAML mode when changing type
        applyStateToForm();
      });
      document.getElementById('yamlPreview').addEventListener('input', () => {
        const editor = document.getElementById('yamlEditor');
        if (editor) editor.value = document.getElementById('yamlPreview').value;
        onEditorContentChanged();
      });
      document.getElementById('copyBtn').addEventListener('click', () => {
        const text = document.getElementById('yamlPreview').value;
        navigator.clipboard.writeText(text);
      });
        // Save template button
        document.getElementById('saveTemplateBtn').addEventListener('click', (e) => {
          e.preventDefault();
          saveTemplate();
        });
      document.getElementById('downloadBtn').addEventListener('click', () => {
        window.location.href = '/api/download';
      });
      document.getElementById('themeSelect').addEventListener('change', (e) => setTheme(e.target.value));
      // Enable bootstrap tooltips
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
      tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el) })
    }

    // Insert example YAML into the editor
    function insertExample(which) {
      let content = '';
      if (which === 'alert') {
        content = `{% raw %}groups:
  - name: example_alerts
    rules:
      - alert: HighCPU
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: High CPU on {{ $labels.instance }}{% endraw %}`;
      } else if (which === 'record') {
        content = `{% raw %}groups:
  - name: example_recordings
    rules:
      - record: instance:cpu_usage:rate5m
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100){% endraw %}`;
      } else if (which === 'combined') {
        content = `{% raw %}groups:
  - name: example_combined
    rules:
      - alert: HighMemory
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
      - record: instance:memory_usage:percent
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100{% endraw %}`;
      }
      document.getElementById('yamlEditor').value = content;
      onEditorContentChanged();
      // If in form mode, render form editor
      if (state.editorMode === 'form') renderFormEditor(content);
    }

    // ────────────────────────────────────────────────────────────────
    // Initialisation
    // ────────────────────────────────────────────────────────────────
    function init() {
      applySavedTheme();
      loadTemplates();
      bindUI();
      fetch('/api/state').then(r => r.json()).then(s => {
        state.current = s;
        if (!s.name) {
          state.current = { id: null, name:'Untitled', type:'rule', job_category:'', sensor_type:'', description:'', content:'groups: []' };
        }
        applyStateToForm();
      });
    }

    // Load the js‑yaml library, then start the app
    document.addEventListener('DOMContentLoaded', () => {
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js';
      s.onload = init;
      document.head.appendChild(s);
    });
  </script>
  
  <!-- Help footer -->
  <div class="container-fluid py-3">
    <div class="card mt-3">
      <div class="card-header">Quick Help & Tips</div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <h6>Prometheus Rule Structure</h6>
            <ul>
              <li>Rules are grouped under <code>groups:</code> each group has a <code>name</code> and <code>rules</code>.</li>
              <li>Alerting rule example: <code>alert: HighCPU\nexpr: avg(rate(node_cpu_seconds_total[5m])) &gt; 0.8\nfor: 5m</code></li>
              <li>Recording rule example: <code>record: instance:cpu_usage:rate5m\nexpr: rate(node_cpu_seconds_total[5m])</code></li>
            </ul>
            <div class="mt-2">
              <h6>One-click examples</h6>
              <button class="btn btn-sm btn-outline-primary me-2" onclick="insertExample('alert')">Insert Alert Example</button>
              <button class="btn btn-sm btn-outline-secondary me-2" onclick="insertExample('record')">Insert Recording Example</button>
              <button class="btn btn-sm btn-outline-success" onclick="insertExample('combined')">Insert Combined Example</button>
            </div>
          </div>
          <div class="col-md-6">
            <h6>Quick Tips</h6>
            <ul>
              <li>Use the editor YAML mode for copy/paste of existing files.</li>
              <li>Use the Form Editor to visually build alerts and recordings.</li>
              <li>Merge templates: open the library modal, check templates, click <strong>Merge Selected</strong>.</li>
              <li>Validation results appear on the right; fix errors shown under the preview.</li>
            </ul>
            <p class="mb-0">More docs: <a href="https://prometheus.io/docs/prometheus/latest/configuration/recording_rules/" target="_blank">Recording Rules</a> · <a href="https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/" target="_blank">Alerting Rules</a></p>
          </div>
        </div>
        <hr />
      </div>
    </div>
  </div>
</body>
</html>
